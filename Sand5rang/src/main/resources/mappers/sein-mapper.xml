<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="seinMapper">
	
	<resultMap type="order" id="TodyOrderResultSet">
		<result column="IND_NO" property="indNo"/>
		<result column="COUNT" property="count"/>
		<result column="IND_DATE" property="indDate"/>
		<result column="TOTAL" property="total"/>
		<result column="STATUS" property="status"/>
		<result column="STORE_ID" property="storeId"/>
		<result column="ING_NO" property="ingNo"/>
		<result column="ING_NAME" property="ingName"/>
		<result column="ING_TYPE" property="ingType"/>
		<result column="PRICE" property="price"/>
		<result column="ROWNUM" property="rowNo"/>
		<result column="IND" property="indD"/>
		<result column="'B'" property="b"/>
		<result column="'V'" property="v"/>
		<result column="'C'" property="c"/>
		<result column="'M'" property="m"/>
		<result column="'S'" property="s"/>
	</resultMap>
	
	
	<resultMap type="store" id="StoreResultSet">
		<result column="STORE_ID" property="storeId"/>
		<result column="STORE_PWD" property="storePwd"/>
		<result column="STORE_NAME" property="storeName"/>
		<result column="ADDRESS" property="address"/>
		<result column="STATUS" property="status"/>
		<result column="ENR_NO" property="enrNo"/>
	</resultMap>

	<!-- 로그인 -->
	<select id="loginStore" parameterType="store" resultMap="StoreResultSet">
		SELECT STORE_ID, STORE_PWD, STORE_NAME, ADDRESS, STATUS, ENR_NO
		FROM STORE 
		WHERE STORE_ID = #{storeId} AND
		STATUS = 'Y'
	</select>
	
	<update id="newPwdUpdate" parameterType="store">
		UPDATE STORE SET STORE_PWD = #{storePwd} 
					 WHERE STORE_ID = #{storeId} 
					 AND STATUS = 'Y'
	</update>
	
	
	<!-- 발주 체크 select -->
	<select id="selectOrder" parameterType="string" resultType="_int">
		SELECT COUNT(IND_NO) AS COUNT_NO
		FROM INDENT
		WHERE STORE_ID = #{storeId} AND
			  TO_CHAR(IND_DATE, 'YY-MM-DD') = TO_CHAR(SYSDATE, 'YY-MM-DD')
	</select>
	
	<!-- 발주insert -->
	<insert id="insertOrder" parameterType="order">
		INSERT INTO INDENT(IND_NO, 
                    		COUNT, 
                    		IND_DATE, 
                    		TOTAL, 
                    		STATUS,
                    		STORE_ID,
                    		ING_NO)  
					VALUES(SEQ_INDENTNO.NEXTVAL, 
						 #{count}, 
						 SYSDATE, 
						 #{total}, 
						 #{status}, 
						 #{storeId}, 
						 #{ingNo})
	</insert>
	
	<!-- 발주상세조회 select -->
	<select id="selectTodayOrder" parameterType="string" resultMap="TodyOrderResultSet">
		SELECT IND_NO, COUNT, IND_DATE, TOTAL, STATUS, STORE_ID, ING_NO, ING_NAME, ING_TYPE
		FROM INDENT JOIN INGREDIENT USING(ING_NO) 
		WHERE STORE_ID = #{storeId} 
		      AND TO_CHAR(IND_DATE, 'YY-MM-DD') = TO_CHAR(SYSDATE, 'YY-MM-DD') 
		ORDER BY ING_NO ASC
	</select>

	<!-- 발주전체조회 select -->
	<select id="selectAllOrderList" parameterType="string" resultMap="TodyOrderResultSet">
		SELECT ROWNUM, A.*
		FROM(SELECT *
		      FROM (SELECT ING_TYPE, COUNT, IND_DATE, STATUS
		            FROM INDENT JOIN INGREDIENT USING(ING_NO)
                    WHERE STORE_ID = #{storeId})
		      PIVOT (SUM(COUNT) FOR ING_TYPE IN('B', 'V', 'M', 'C', 'S'))
		      ORDER BY IND_DATE ASC) A
		ORDER BY IND_DATE DESC
	</select>
	
	<!-- 자동발주신청 select -->
	<select id="selectAutoOrder" parameterType="string" resultMap="TodyOrderResultSet">
	     SELECT TO_DATE(IND_DATE, 'YY-MM-DD HH24:MI:SS') IND_DATE, IND_NO, COUNT, TOTAL, STATUS, STORE_ID, ING_NO
		 FROM INDENT 
		 WHERE STORE_ID = #{storeId} 
		 AND TO_CHAR(IND_DATE, 'YY-MM-DD HH24:MI:SS') BETWEEN TO_CHAR(TO_DATE(SYSDATE, 'YY-MM-DD HH24:MI:SS') - INTERVAL '33' HOUR, 'YY-MM-DD HH24:MI:SS') AND
		                         TO_CHAR(TO_DATE(SYSDATE, 'YY-MM-DD HH24:MI:SS') + INTERVAL '15' HOUR, 'YY-MM-DD HH24:MI:SS')
		 AND STATUS ='AB'
	</select>
	
	<!-- 가맹점 발주대기 상태의 원재료 list select -->
	<select id="selectOrder2" parameterType="string" resultMap="TodyOrderResultSet">
		SELECT IND_NO, COUNT, IND_DATE, TOTAL, STATUS, STORE_ID, ING_NO, ING_NAME, PRICE
		FROM INDENT JOIN INGREDIENT USING(ING_NO) 
		WHERE STORE_ID = #{storeId} AND 
		      TO_CHAR(IND_DATE, 'YY-MM-DD') = TO_CHAR(SYSDATE, 'YY-MM-DD') AND 
		      STATUS LIKE '%B' 
		ORDER BY ING_NO
	</select>
	
	<update id="updateOrder" parameterType="order">
	</update>
	
</mapper>
